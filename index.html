<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Restaurant Chat</title>
  <style>
    /* Your existing CSS styles go here */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; display: flex; flex-direction: column; height: 100vh; }
    header { background: #2c3e50; color: white; padding: 15px; text-align: center; font-size: 1.25rem; }
    main { flex: 1; overflow-y: auto; padding: 20px; }
    .message { margin-bottom: 10px; display: flex; }
    .message.user .bubble { background: #3498db; color: white; margin-left: auto; }
    .message.bot .bubble { background: #ecf0f1; color: #2c3e50; margin-right: auto; }
    .bubble { padding: 10px 15px; border-radius: 15px; max-width: 70%; word-wrap: break-word; }
    footer { padding: 10px 20px; background: #fff; border-top: 1px solid #ddd; display: flex; align-items: center; gap: 10px; }
    input[type="text"] { flex: 1; padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 10px 15px; font-size: 1rem; background: #2ecc71; border: none; border-radius: 4px; color: white; cursor: pointer; }
    button:disabled { background: #95a5a6; cursor: not-allowed; }
    .notification { text-align: center; padding: 10px; background: #f1c40f; color: #2c3e50; font-weight: bold; }
  </style>
</head>
<body>

  <header id="header">Restaurant Chat</header>
  <main id="chatWindow">
    </main>
  <footer>
    <input type="text" id="chatInput" placeholder="Type your message…" autocomplete="off" />
    <button id="sendButton" disabled>Send</button>
  </footer>

  <script>
    (function() {
      // Function to generate a UUID (Unique User Session ID)
      function generateUUID() {
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
              var r = Math.random() * 16 | 0,
                  v = c == 'x' ? r : (r & 0x3 | 0x8);
              return v.toString(16);
          });
      }

      // Get or create a unique user session ID and store it in localStorage
      let userSessionId = localStorage.getItem('userSessionId');
      if (!userSessionId) {
          userSessionId = generateUUID();
          localStorage.setItem('userSessionId', userSessionId);
      }
      console.log("Current User Session ID:", userSessionId); // For debugging purposes

      // 1) Extract restaurant_id and restaurant_name from query string
      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          id: params.get('restaurant_id'),
          name: params.get('restaurant_name')
        };
      }

      const { id: restaurantId, name: restaurantName } = getQueryParams(); // Correctly gets from query params

      const headerEl = document.getElementById('header');
      const chatWindow = document.getElementById('chatWindow');
      const chatInput = document.getElementById('chatInput');
      const sendButton = document.getElementById('sendButton');

      // 2) If no restaurant_id, show a warning and disable input
      if (!restaurantId) {
        headerEl.textContent = 'Error: No restaurant_id provided';
        const warn = document.createElement('div');
        warn.className = 'notification';
        warn.textContent = 'This chat page requires ?restaurant_id=R001 (or similar) in the URL.';
        chatWindow.appendChild(warn);
        return;
      }

      // 3) Update header to show which restaurant the user is chatting with
      if (restaurantName) {
        headerEl.textContent = `Chatting with ${decodeURIComponent(restaurantName)}`;
      } else {
        headerEl.textContent = `Chatting with Restaurant ${restaurantId}`;
      }

      // 4) Enable send button when user types
      chatInput.addEventListener('input', () => {
        sendButton.disabled = chatInput.value.trim().length === 0;
      });

      // 5) Helper to append a message bubble
      function appendMessage(text, sender) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message ' + sender;
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.textContent = text;
        msgDiv.appendChild(bubble);
        chatWindow.appendChild(msgDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      // 6) On first load, show a greeting
      appendMessage('Hello! How can I help you today?', 'bot');

      // 7) Handle send button click
      sendButton.addEventListener('click', async () => {
        const userText = chatInput.value.trim();
        if (!userText) return;

        appendMessage(userText, 'user');
        chatInput.value = '';
        sendButton.disabled = true;

        // 8) Call the n8n Webhook:
        // Use the n8n webhook URL from Workflow 1 (Trigger URL).
        // restaurantId is still in the URL path, but userSessionId is in the body.
        const n8nBaseWebhookUrl = 'https://rami215.app.n8n.cloud/webhook/1b80b05d-0a0b-4e4c-8d6f-970330f6587b'; 
        const webhookUrl = `${n8nBaseWebhookUrl}/chat/${encodeURIComponent(restaurantId)}`; // Only restaurantId in path

        try {
          const typingNode = document.createElement('div');
          typingNode.className = 'message bot';
          typingNode.id = 'typingIndicator';
          typingNode.innerHTML = '<div class="bubble">Typing...</div>';
          chatWindow.appendChild(typingNode);
          chatWindow.scrollTop = chatWindow.scrollHeight;

          const response = await fetch(webhookUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            // --- IMPORTANT CHANGE HERE: userSessionId included in the JSON body ---
            body: JSON.stringify({ 
                message: userText,
                userSessionId: userSessionId // Sending userSessionId in the body
            })
          });

          document.getElementById('typingIndicator').remove();

          if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
          }
          const data = await response.json();
          appendMessage(data.response, 'bot');
        } catch (err) {
          const indicator = document.getElementById('typingIndicator');
          if (indicator) indicator.remove();

          appendMessage('❌ Error contacting the server. Please try again.', 'bot');
          console.error('Fetch error:', err);
        }
      });

      // Allow Enter key to send
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !sendButton.disabled) {
          sendButton.click();
        }
      });
    })();
  </script>
</body>
</html>